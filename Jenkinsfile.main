pipeline {
    agent any

    stages {
        stage('Checkout') {
            steps {
                echo 'Checking out code...'
                checkout scm
            }
        }

        stage('Setup Credentials') {
            steps {
                echo 'Setting up credentials...'
                withCredentials([
                    file(credentialsId: 'play-store-credentials', variable: 'PLAY_CREDENTIALS')
                ]) {
                    sh '''
                        cp $PLAY_CREDENTIALS play-store-credentials.json
                        echo "sdk.dir=/Users/leewoojin/Library/Android/sdk" > local.properties
                    '''
                }
            }
        }

        stage('Approve: Closed Testing') {
            steps {
                timeout(time: 24, unit: 'HOURS') {
                    input message: 'ë‚´ë¶€ í…ŒìŠ¤íŠ¸ â†’ ë¹„ê³µê°œ í…ŒìŠ¤íŠ¸(Closed Testing)ë¡œ ìŠ¹ê²©í• ê¹Œìš”?', ok: 'ìŠ¹ê²©'
                }
            }
        }

        stage('Promote: Internal â†’ Closed Testing') {
            steps {
                echo 'Promoting Internal â†’ Closed Testing (alpha)...'
                sh './gradlew :androidApp:promoteReleaseArtifact -PfromTrack=internal -PpromoteTrack=alpha'
            }
        }

        stage('Approve: Open Testing') {
            steps {
                timeout(time: 24, unit: 'HOURS') {
                    input message: 'ë¹„ê³µê°œ í…ŒìŠ¤íŠ¸ â†’ ê³µê°œ í…ŒìŠ¤íŠ¸(Open Testing)ë¡œ ìŠ¹ê²©í• ê¹Œìš”?', ok: 'ìŠ¹ê²©'
                }
            }
        }

        stage('Promote: Closed â†’ Open Testing') {
            steps {
                echo 'Promoting Closed Testing â†’ Open Testing (beta)...'
                sh './gradlew :androidApp:promoteReleaseArtifact -PfromTrack=alpha -PpromoteTrack=beta'
            }
        }

        stage('Approve: Production') {
            steps {
                timeout(time: 24, unit: 'HOURS') {
                    input message: 'ê³µê°œ í…ŒìŠ¤íŠ¸ â†’ í”„ë¡œë•ì…˜ìœ¼ë¡œ ìµœì¢… ìŠ¹ê²©í• ê¹Œìš”?', ok: 'ìµœì¢… ìŠ¹ê²©'
                }
            }
        }

        stage('Promote: Open Testing â†’ Production') {
            steps {
                echo 'Promoting Open Testing â†’ Production...'
                sh './gradlew :androidApp:promoteReleaseArtifact -PfromTrack=beta -PpromoteTrack=production'
            }
        }
    }

    post {
        success {
            script {
                withCredentials([string(credentialsId: 'discord-webhook', variable: 'WEBHOOK_URL')]) {
                    def message = """
{
  "embeds": [{
    "title": "ğŸš€ í”„ë¡œë•ì…˜ ìŠ¹ê²© ì™„ë£Œ!",
    "description": "PayManagement ì•±ì´ í”„ë¡œë•ì…˜ì— ë°°í¬ë˜ì—ˆìŠµë‹ˆë‹¤.",
    "color": 5763719,
    "fields": [
      {"name": "ğŸ“± ì•± ì´ë¦„", "value": "PayManagement", "inline": true},
      {"name": "ğŸ“¦ ìµœì¢… íŠ¸ë™", "value": "Production", "inline": true},
      {"name": "âœ¨ ê²½ë¡œ", "value": "ë‚´ë¶€ â†’ ë¹„ê³µê°œ â†’ ê³µê°œ â†’ í”„ë¡œë•ì…˜", "inline": false},
      {"name": "â° ë°°í¬ ì‹œê°„", "value": "${new Date().format('yyyy-MM-dd HH:mm:ss')}", "inline": false}
    ],
    "footer": {"text": "Jenkins CI/CD"},
    "timestamp": "${new Date().format("yyyy-MM-dd'T'HH:mm:ss.SSS'Z'")}"
  }]
}
"""
                    sh """
                        curl -H "Content-Type: application/json" \
                             -X POST \
                             -d '${message}' \
                             \${WEBHOOK_URL}
                    """
                }
            }
        }

        failure {
            script {
                withCredentials([string(credentialsId: 'discord-webhook', variable: 'WEBHOOK_URL')]) {
                    def message = """
{
  "embeds": [{
    "title": "âŒ ìŠ¹ê²© ì‹¤íŒ¨!",
    "description": "PayManagement ì•± íŠ¸ë™ ìŠ¹ê²© ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.",
    "color": 16711680,
    "fields": [
      {"name": "ğŸ“± ì•± ì´ë¦„", "value": "PayManagement", "inline": true},
      {"name": "âš ï¸ ìƒíƒœ", "value": "ìŠ¹ê²© ì‹¤íŒ¨", "inline": true},
      {"name": "â° ì‹¤íŒ¨ ì‹œê°„", "value": "${new Date().format('yyyy-MM-dd HH:mm:ss')}", "inline": false},
      {"name": "ğŸ”— ì—ëŸ¬ ë¡œê·¸", "value": "[Jenkinsì—ì„œ í™•ì¸](${env.BUILD_URL}console)", "inline": false}
    ],
    "footer": {"text": "Jenkins CI/CD"},
    "timestamp": "${new Date().format("yyyy-MM-dd'T'HH:mm:ss.SSS'Z'")}"
  }]
}
"""
                    sh """
                        curl -H "Content-Type: application/json" \
                             -X POST \
                             -d '${message}' \
                             \${WEBHOOK_URL}
                    """
                }
            }
        }

        cleanup {
            echo 'Cleaning up credentials...'
            sh '''
                rm -f play-store-credentials.json
                rm -f local.properties
            '''
        }
    }
}
